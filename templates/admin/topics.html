{% extends "admin/base.html" %}

{% block title %}Manage Topics{% endblock %}

{% block content %}
<div class="page-header">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
        <div>
            <h1 class="page-title">Content Topics</h1>
            <p class="page-subtitle">Manage topics for AI content generation and blog organization</p>
        </div>
        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
            <button onclick="showImportModal()" class="btn btn-outline">
                üìÅ Import CSV
            </button>
            <button onclick="showAddModal()" class="btn btn-primary">
                ‚ûï Add Topic
            </button>
        </div>
    </div>
</div>

<!-- Stats Overview -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon">üìÇ</div>
        <div class="stat-number">{{ topics|length }}</div>
        <div class="stat-label">Total Topics</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">‚úÖ</div>
        <div class="stat-number">{{ topics|selectattr('is_active')|list|length }}</div>
        <div class="stat-label">Active Topics</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">ü§ñ</div>
        <div class="stat-number">{{ topics|selectattr('category_name')|list|length }}</div>
        <div class="stat-label">Categorized</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">üìä</div>
        <div class="stat-number">{{ ((topics|selectattr('is_active')|list|length / topics|length * 100) if topics else 0)|round|int }}%</div>
        <div class="stat-label">Active Rate</div>
    </div>
</div>

<!-- Topics Management -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">All Topics ({{ topics|length }})</h3>
    </div>
    <div class="card-body" style="padding: 0;">
        {% if topics %}
        <table class="table">
            <thead>
                <tr>
                    <th>Topic Name</th>
                    <th>Category</th>
                    <th>Status</th>
                    <th>Priority</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for topic in topics %}
                <tr>
                    <td>
                        <div style="font-weight: 600; margin-bottom: 4px;">{{ topic.name }}</div>
                        {% if topic.description %}
                        <div style="color: var(--text-gray); font-size: 12px;">{{ topic.description[:100] }}{% if topic.description|length > 100 %}...{% endif %}</div>
                        {% endif %}
                    </td>
                    <td>
                        {% if topic.category_name %}
                        <span class="status-badge" style="background: rgba(240, 185, 11, 0.1); color: var(--primary-gold);">
                            {{ topic.category_name }}
                        </span>
                        {% else %}
                        <span style="color: var(--text-gray);">No category</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if topic.is_active %}
                        <span class="status-badge status-active">Active</span>
                        {% else %}
                        <span class="status-badge status-inactive">Inactive</span>
                        {% endif %}
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 4px;">
                            {% for i in range(topic.priority or 1) %}
                            <span style="color: var(--primary-gold);">‚≠ê</span>
                            {% endfor %}
                            <span style="color: var(--text-gray); font-size: 12px; margin-left: 8px;">{{ topic.priority or 1 }}</span>
                        </div>
                    </td>
                    <td>
                        <div>{{ topic.created_at.strftime('%m/%d/%Y') }}</div>
                        <div style="color: var(--text-gray); font-size: 12px;">{{ topic.created_at.strftime('%I:%M %p') }}</div>
                    </td>
                    <td>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="editTopic({{ topic.id }}, '{{ topic.name }}', {{ topic.category_id or 'null' }}, {{ topic.is_active|tojson }})">
                                Edit
                            </button>
                            <button class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;" onclick="generateContent({{ topic.id }})">
                                Generate
                            </button>
                            <button class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="deleteTopic({{ topic.id }})">
                                Delete
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div style="text-align: center; padding: 60px 20px; color: var(--text-gray);">
            <div style="font-size: 4em; margin-bottom: 20px; opacity: 0.5;">üìÇ</div>
            <h3>No topics yet</h3>
            <p>Add topics to start generating AI content automatically.</p>
            <button onclick="showAddModal()" class="btn btn-primary" style="margin-top: 20px;">Add Your First Topic</button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Add Topic Modal -->
<div id="addModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(30, 35, 41, 0.8); z-index: 1001; backdrop-filter: blur(4px);">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 32px; border-radius: 16px; width: 90%; max-width: 500px; box-shadow: var(--shadow-heavy);">
        <h3 style="margin-bottom: 24px; color: var(--text-dark); font-size: 1.4em;">Add New Topic</h3>
        <form id="addTopicForm" action="{{ url_for('admin_add_topic') }}" method="POST">
            <div class="form-group">
                <label class="form-label">Topic Name</label>
                <input type="text" name="topic_name" class="form-input" placeholder="e.g., DeFi Protocols, NFT Marketplace" required>
                <small style="color: var(--text-gray); font-size: 12px;">Enter a descriptive name for the topic</small>
            </div>
            <div class="form-group">
                <label class="form-label">Category</label>
                <select name="category_id" class="form-select">
                    <option value="">Select Category (Optional)</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                    <input type="checkbox" name="is_active" checked style="width: 18px; height: 18px; accent-color: var(--primary-gold);">
                    <span>Active (Generate content for this topic)</span>
                </label>
            </div>
            <div style="display: flex; gap: 12px; justify-content: end; margin-top: 24px;">
                <button type="button" onclick="closeAddModal()" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Topic</button>
            </div>
        </form>
    </div>
</div>

<!-- Import CSV Modal -->
<div id="importModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(30, 35, 41, 0.8); z-index: 1001; backdrop-filter: blur(4px);">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 32px; border-radius: 16px; width: 90%; max-width: 600px; box-shadow: var(--shadow-heavy);">
        <h3 style="margin-bottom: 24px; color: var(--text-dark); font-size: 1.4em;">Import Topics from CSV</h3>
        <form action="{{ url_for('import_topics') }}" method="POST" enctype="multipart/form-data">
            <div class="form-group">
                <label class="form-label">CSV File</label>
                <input type="file" name="csv_file" class="form-input" accept=".csv" required>
                <small style="color: var(--text-gray); font-size: 12px;">Upload a CSV file with topic data</small>
            </div>
            <div style="background: rgba(240, 185, 11, 0.1); padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid var(--primary-gold);">
                <strong style="color: var(--primary-gold);">CSV Format Example:</strong>
                <pre style="margin: 12px 0; font-family: 'Monaco', 'Courier New', monospace; font-size: 13px; color: var(--text-dark);">topic_name,category_id,description
DeFi Protocols,1,Latest DeFi innovations
NFT Marketplace,1,NFT trading platforms
Bitcoin Mining,4,Cryptocurrency mining news</pre>
                <small style="color: var(--text-gray);">Category ID is optional (use numbers or leave empty)</small>
            </div>
            <div style="display: flex; gap: 12px; justify-content: end;">
                <button type="button" onclick="closeImportModal()" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-primary">Import Topics</button>
            </div>
        </form>
    </div>
</div>

<script>
function showAddModal() {
    document.getElementById('addModal').style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function closeAddModal() {
    document.getElementById('addModal').style.display = 'none';
    document.body.style.overflow = 'auto';
}

function showImportModal() {
    document.getElementById('importModal').style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function closeImportModal() {
    document.getElementById('importModal').style.display = 'none';
    document.body.style.overflow = 'auto';
}

function editTopic(id, name, categoryId, isActive) {
    // For now, just show an alert. You can implement a proper edit modal later
    alert(`Edit Topic: ${name}\nID: ${id}\nCategory: ${categoryId}\nActive: ${isActive}`);
}

function generateContent(topicId) {
    if (confirm('Generate AI content for this topic?')) {
        // Implement AI content generation
        alert(`Generating content for topic ID: ${topicId}`);
    }
}

function deleteTopic(topicId) {
    if (confirm('Are you sure you want to delete this topic? This action cannot be undone.')) {
        // Implement delete functionality
        alert(`Delete topic ID: ${topicId}`);
    }
}

// Close modals when clicking outside
document.getElementById('addModal').addEventListener('click', function(e) {
    if (e.target === this) closeAddModal();
});

document.getElementById('importModal').addEventListener('click', function(e) {
    if (e.target === this) closeImportModal();
});

// Close modals with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeAddModal();
        closeImportModal();
    }
});
</script>
{% endblock %}
