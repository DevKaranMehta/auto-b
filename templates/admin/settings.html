{% extends "admin/base.html" %}

{% block title %}Settings{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Platform Settings</h1>
    <p class="page-subtitle">Configure AI scheduling with multiple frequency options</p>
</div>

<form action="{{ url_for('update_settings') }}" method="POST">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">🤖 AI Content Generation & Scheduling</h3>
        </div>
        <div class="card-body">
            
            <!-- Generation Settings -->
            <div class="form-group">
                <label class="form-label">Posts per Day (1-20)</label>
                <select name="posts_per_day" class="form-select">
                    {% for i in range(1, 21) %}
                    <option value="{{ i }}" {% if settings.get('posts_per_day', '3') == i|string %}selected{% endif %}>{{ i }} Post{{ 's' if i > 1 else '' }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Schedule Frequency Options -->
            <div class="form-group">
                <label class="form-label">Schedule Frequency</label>
                <select name="schedule_frequency" class="form-select" onchange="toggleScheduleOptions(this.value)">
                    <option value="every_minute" {% if settings.get('schedule_frequency', 'daily') == 'every_minute' %}selected{% endif %}>Every Minute</option>
                    <option value="hourly" {% if settings.get('schedule_frequency', 'daily') == 'hourly' %}selected{% endif %}>Every Hour</option>
                    <option value="every_3_hours" {% if settings.get('schedule_frequency', 'daily') == 'every_3_hours' %}selected{% endif %}>Every 3 Hours</option>
                    <option value="every_6_hours" {% if settings.get('schedule_frequency', 'daily') == 'every_6_hours' %}selected{% endif %}>Every 6 Hours</option>
                    <option value="every_9_hours" {% if settings.get('schedule_frequency', 'daily') == 'every_9_hours' %}selected{% endif %}>Every 9 Hours</option>
                    <option value="daily" {% if settings.get('schedule_frequency', 'daily') == 'daily' %}selected{% endif %}>Daily</option>
                    <option value="weekly" {% if settings.get('schedule_frequency', 'daily') == 'weekly' %}selected{% endif %}>Weekly</option>
                    <option value="monthly" {% if settings.get('schedule_frequency', 'daily') == 'monthly' %}selected{% endif %}>Monthly</option>
                </select>
                <small style="color: var(--text-gray); font-size: 12px;">Choose how often AI should generate posts</small>
            </div>

            <!-- Time Settings (for daily/weekly/monthly) -->
            <div class="form-group" id="timeSettings">
                <label class="form-label">Generation Time</label>
                <input type="time" name="generation_schedule_time" class="form-input" 
                       value="{{ settings.get('generation_schedule_time', '09:00') }}">
                <small style="color: var(--text-gray); font-size: 12px;">Time to run scheduled generation</small>
            </div>

            <!-- Generation Options -->
            <div class="form-group">
                <label class="form-label">Generation Options</label>
                <div style="display: grid; gap: 12px;">
                    <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                        <input type="checkbox" name="ai_generation_enabled" 
                               {% if settings.get('ai_generation_enabled', 'true') == 'true' %}checked{% endif %}
                               style="width: 18px; height: 18px; accent-color: var(--primary-gold);">
                        <span>Enable AI content generation</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                        <input type="checkbox" name="auto_publish_enabled" 
                               {% if settings.get('auto_publish_enabled', 'true') == 'true' %}checked{% endif %}
                               style="width: 18px; height: 18px; accent-color: var(--primary-gold);">
                        <span>Auto-publish generated content</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                        <input type="checkbox" name="weekend_generation" 
                               {% if settings.get('weekend_generation', 'true') == 'true' %}checked{% endif %}
                               style="width: 18px; height: 18px; accent-color: var(--primary-gold);">
                        <span>Generate content on weekends</span>
                    </label>
                </div>
            </div>

            <!-- Quick Test Section -->
            <div style="background: rgba(240, 185, 11, 0.1); padding: 20px; border-radius: 12px; border-left: 4px solid var(--primary-gold); margin-top: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong style="color: var(--primary-gold);">Quick Test</strong>
                        <p style="color: var(--text-gray); font-size: 12px; margin: 4px 0;">Test AI generation immediately</p>
                    </div>
                    <button type="button" onclick="testGenerateNow()" class="btn btn-success">
                        🚀 Generate Now
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Button -->
    <div style="text-align: center; margin-top: 32px;">
        <button type="submit" class="btn btn-primary" style="padding: 16px 48px; font-size: 1.1em;">
            💾 Save Settings & Restart Scheduler
        </button>
    </div>
</form>

<!-- Status Display -->
<div class="card" style="margin-top: 24px;">
    <div class="card-header">
        <h3 class="card-title">📊 Current Schedule Status</h3>
    </div>
    <div class="card-body">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
            <div style="text-align: center; padding: 16px; background: rgba(2, 192, 118, 0.1); border-radius: 10px;">
                <div style="font-size: 1.5em; margin-bottom: 8px;">🤖</div>
                <div style="font-weight: 600;">AI Generation</div>
                <div style="font-size: 12px; color: var(--text-gray);">{{ 'Enabled' if settings.get('ai_generation_enabled', 'true') == 'true' else 'Disabled' }}</div>
            </div>
            
            <div style="text-align: center; padding: 16px; background: rgba(240, 185, 11, 0.1); border-radius: 10px;">
                <div style="font-size: 1.5em; margin-bottom: 8px;">⏰</div>
                <div style="font-weight: 600;">Frequency</div>
                <div style="font-size: 12px; color: var(--text-gray);">{{ settings.get('schedule_frequency', 'daily').replace('_', ' ').title() }}</div>
            </div>
            
            <div style="text-align: center; padding: 16px; background: rgba(14, 205, 240, 0.1); border-radius: 10px;">
                <div style="font-size: 1.5em; margin-bottom: 8px;">📝</div>
                <div style="font-weight: 600;">Posts per Day</div>
                <div style="font-size: 12px; color: var(--text-gray);">{{ settings.get('posts_per_day', '3') }} articles</div>
            </div>
            
            <div style="text-align: center; padding: 16px; background: rgba(248, 73, 96, 0.1); border-radius: 10px;">
                <div style="font-size: 1.5em; margin-bottom: 8px;">🚀</div>
                <div style="font-weight: 600;">Auto Publish</div>
                <div style="font-size: 12px; color: var(--text-gray);">{{ 'Yes' if settings.get('auto_publish_enabled', 'true') == 'true' else 'No' }}</div>
            </div>
        </div>
    </div>
</div>

<script>
function toggleScheduleOptions(frequency) {
    const timeSettings = document.getElementById('timeSettings');
    const needsTime = ['daily', 'weekly', 'monthly'].includes(frequency);
    timeSettings.style.display = needsTime ? 'block' : 'none';
}

function testGenerateNow() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '🔄 Generating...';
    btn.disabled = true;
    
    fetch('/admin/ai-scheduler/generate-now', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (response.ok) {
            alert('✅ AI post generation triggered successfully! Check your posts dashboard.');
            setTimeout(() => location.reload(), 2000);
        } else {
            alert('❌ Generation failed. Please check your settings and topics.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('❌ Error triggering generation');
    })
    .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

// Initialize display
window.addEventListener('load', function() {
    toggleScheduleOptions(document.querySelector('select[name="schedule_frequency"]').value);
});
</script>
{% endblock %}
