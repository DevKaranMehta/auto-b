{% extends "admin/base.html" %}

{% block title %}Job Scheduler{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-8">
    <h1 class="text-3xl font-bold">‚è∞ Advanced Job Scheduler</h1>
    <div class="space-x-4">
        <button onclick="openAddJobModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
            ‚ûï Add Custom Job
        </button>
        <button onclick="openQuickScheduleModal()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
            üöÄ Quick Schedule
        </button>
        <a href="/admin/trending-topics" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded">
            üî• Trending Topics
        </a>
    </div>
</div>

<!-- Success/Error Messages -->
{% if request.query_params.get('success') %}
<div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
    ‚úÖ {{ request.query_params.get('success') }}
</div>
{% endif %}

{% if request.query_params.get('error') %}
<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
    ‚ùå {{ request.query_params.get('error') }}
</div>
{% endif %}

<!-- Active Jobs Display -->
<div class="bg-white rounded-lg shadow-lg mb-8">
    <div class="p-6 border-b">
        <div class="flex justify-between items-center">
            <div>
                <h2 class="text-xl font-bold">üìã Active Scheduled Jobs</h2>
                <p class="text-gray-600 mt-2">Real-time countdown to next execution</p>
            </div>
            <div class="text-sm text-gray-500">
                <span id="lastUpdated">Last updated: Loading...</span>
                <br>
                <span id="refreshStatus" class="text-blue-600">üîÑ Auto-refresh: ON</span>
            </div>
        </div>
    </div>
    <div class="p-6">
        <div id="jobs-container">
            <!-- Jobs will be loaded here -->
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <div class="bg-white p-6 rounded-lg shadow-lg border-l-4 border-purple-500">
        <h3 class="text-lg font-bold text-purple-600 mb-2">üî• Trending Topics</h3>
        <p class="text-gray-600 mb-4">Update AI-generated trending topics</p>
        <button onclick="addPredefinedJob('trending_topics')" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded">
            Add Trending Job
        </button>
    </div>
    
    <div class="bg-white p-6 rounded-lg shadow-lg border-l-4 border-blue-500">
        <h3 class="text-lg font-bold text-blue-600 mb-2">üìù Blog Generation</h3>
        <p class="text-gray-600 mb-4">Auto-generate blog posts</p>
        <button onclick="addPredefinedJob('blog_generation')" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
            Add Blog Job
        </button>
    </div>
    
    <div class="bg-white p-6 rounded-lg shadow-lg border-l-4 border-green-500">
        <h3 class="text-lg font-bold text-green-600 mb-2">üßπ Cleanup Tasks</h3>
        <p class="text-gray-600 mb-4">Database maintenance jobs</p>
        <button onclick="addPredefinedJob('cleanup')" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
            Add Cleanup Job
        </button>
    </div>
</div>

<!-- Enhanced Quick Schedule Modal with Minutes -->
<div id="quickScheduleModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen">
        <div class="bg-white rounded-lg p-6 w-full max-w-3xl">
            <h3 class="text-lg font-bold mb-4">üöÄ Quick Schedule Job</h3>
            <form method="POST" action="/admin/scheduler/quick-schedule">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Job Type</label>
                        <select name="job_type" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Select Job Type</option>
                            <option value="trending_topics">üî• Update Trending Topics</option>
                            <option value="blog_generation">üìù Generate Blog Posts</option>
                            <option value="cleanup">üßπ Database Cleanup</option>
                            <option value="newsletter">ÔøΩÔøΩ Newsletter Digest</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Schedule Frequency</label>
                        <select name="schedule_type" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="updateScheduleOptions(this.value)">
                            <option value="">Select Frequency</option>
                            <optgroup label="‚è±Ô∏è Minute Intervals">
                                <option value="every_1_minute">Every 1 Minute</option>
                                <option value="every_2_minutes">Every 2 Minutes</option>
                                <option value="every_3_minutes">Every 3 Minutes</option>
                                <option value="every_5_minutes">Every 5 Minutes</option>
                                <option value="every_10_minutes">Every 10 Minutes</option>
                                <option value="every_15_minutes">Every 15 Minutes</option>
                                <option value="every_20_minutes">Every 20 Minutes</option>
                                <option value="every_30_minutes">Every 30 Minutes</option>
                                <option value="custom_minutes">Custom Minutes</option>
                            </optgroup>
                            <optgroup label="‚è∞ Hour Intervals">
                                <option value="hourly">Every Hour</option>
                                <option value="every_2_hours">Every 2 Hours</option>
                                <option value="every_4_hours">Every 4 Hours</option>
                                <option value="every_6_hours">Every 6 Hours</option>
                                <option value="every_12_hours">Every 12 Hours</option>
                            </optgroup>
                            <optgroup label="üìÖ Time-Based">
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                            </optgroup>
                            <optgroup label="üîß Advanced">
                                <option value="custom_cron">Custom Cron Expression</option>
                            </optgroup>
                        </select>
                    </div>
                </div>
                
                <!-- Custom Minutes Input -->
                <div id="customMinutesInput" class="mt-4 hidden">
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <label class="block text-sm font-medium text-blue-700 mb-2">‚è±Ô∏è Custom Minutes Interval</label>
                        <div class="flex items-center space-x-2">
                            <span class="text-blue-600">Every</span>
                            <input type="number" name="custom_minutes_value" min="1" max="1440" value="10" class="w-20 px-3 py-2 border border-blue-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <span class="text-blue-600">minutes</span>
                        </div>
                        <p class="text-xs text-blue-600 mt-1">Range: 1-1440 minutes (1 minute to 24 hours)</p>
                    </div>
                </div>
                
                <!-- Time Selection for Daily/Weekly/Monthly -->
                <div id="timeSelection" class="mt-4 hidden">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Hour (0-23)</label>
                            <select name="hour" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                <option value="0">00:00 (Midnight)</option>
                                <option value="1">01:00</option>
                                <option value="2">02:00</option>
                                <option value="3">03:00</option>
                                <option value="4">04:00</option>
                                <option value="5">05:00</option>
                                <option value="6">06:00</option>
                                <option value="7">07:00</option>
                                <option value="8">08:00</option>
                                <option value="9" selected>09:00</option>
                                <option value="10">10:00</option>
                                <option value="11">11:00</option>
                                <option value="12">12:00 (Noon)</option>
                                <option value="13">13:00</option>
                                <option value="14">14:00</option>
                                <option value="15">15:00</option>
                                <option value="16">16:00</option>
                                <option value="17">17:00</option>
                                <option value="18">18:00</option>
                                <option value="19">19:00</option>
                                <option value="20">20:00</option>
                                <option value="21">21:00</option>
                                <option value="22">22:00</option>
                                <option value="23">23:00</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Minute</label>
                            <select name="minute" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                <option value="0" selected>00</option>
                                <option value="5">05</option>
                                <option value="10">10</option>
                                <option value="15">15</option>
                                <option value="20">20</option>
                                <option value="25">25</option>
                                <option value="30">30</option>
                                <option value="35">35</option>
                                <option value="40">40</option>
                                <option value="45">45</option>
                                <option value="50">50</option>
                                <option value="55">55</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Day of Week for Weekly -->
                <div id="dayOfWeekSelection" class="mt-4 hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Day of Week</label>
                    <select name="day_of_week" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        <option value="1" selected>Monday</option>
                        <option value="2">Tuesday</option>
                        <option value="3">Wednesday</option>
                        <option value="4">Thursday</option>
                        <option value="5">Friday</option>
                        <option value="6">Saturday</option>
                        <option value="0">Sunday</option>
                    </select>
                </div>
                
                <!-- Day of Month for Monthly -->
                <div id="dayOfMonthSelection" class="mt-4 hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Day of Month</label>
                    <select name="day" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        <option value="1" selected>1st</option>
                        <option value="2">2nd</option>
                        <option value="3">3rd</option>
                        <option value="4">4th</option>
                        <option value="5">5th</option>
                        <option value="10">10th</option>
                        <option value="15">15th</option>
                        <option value="20">20th</option>
                        <option value="25">25th</option>
                        <option value="28">28th (Safe for all months)</option>
                    </select>
                </div>
                
                <!-- Custom Cron Expression -->
                <div id="customCronSelection" class="mt-4 hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Custom Cron Expression</label>
                    <input type="text" name="cron_expression" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="0 0 * * *">
                    <p class="text-xs text-gray-500 mt-1">Format: minute hour day month day_of_week</p>
                    <div class="mt-2">
                        <p class="text-xs text-gray-600">Examples:</p>
                        <p class="text-xs text-gray-500">‚Ä¢ 0 0 * * * = Daily at midnight</p>
                        <p class="text-xs text-gray-500">‚Ä¢ 0 */2 * * * = Every 2 hours</p>
                        <p class="text-xs text-gray-500">‚Ä¢ */5 * * * * = Every 5 minutes</p>
                    </div>
                </div>
                
                <div class="mt-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Job Description (Optional)</label>
                    <input type="text" name="description" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Brief description of what this job does">
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeQuickScheduleModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        Schedule Job
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Custom Job Modal -->
<div id="addJobModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen">
        <div class="bg-white rounded-lg p-6 w-full max-w-lg">
            <h3 class="text-lg font-bold mb-4">‚ûï Add Custom Job</h3>
            <form method="POST" action="/admin/scheduler/add-job">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Job ID</label>
                        <input type="text" name="job_id" required class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="unique_job_id">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Job Function</label>
                        <select name="job_function" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            <option value="">Select Function</option>
                            <option value="update_trending_topics_only">Update Trending Topics</option>
                            <option value="generate_blog_only">Generate Blog Posts</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Schedule Type</label>
                        <select name="schedule_type" required class="w-full px-3 py-2 border border-gray-300 rounded-md" onchange="toggleMinutesInput(this.value)">
                            <option value="interval">Interval (Hours/Minutes)</option>
                            <option value="cron">Cron Expression</option>
                        </select>
                    </div>
                    <div id="minutesInputSection">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Minutes (for interval)</label>
                        <input type="number" name="minutes" min="1" max="1440" value="30" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="30">
                        <p class="text-xs text-gray-500 mt-1">Enter minutes: 1-59 for minute intervals, 60+ for hour intervals</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <input type="text" name="description" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Job description">
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeAddJobModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        Add Job
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// ENHANCED: Global variables for real-time updates
let jobsData = [];
let countdownInterval;
let dataRefreshInterval;

// Load jobs on page load
document.addEventListener('DOMContentLoaded', function() {
    loadJobs();
    startRealTimeUpdates();
});

// ENHANCED: Start real-time updates
function startRealTimeUpdates() {
    // Update countdowns every second
    countdownInterval = setInterval(updateCountdowns, 1000);
    
    // Refresh job data every 10 seconds
    dataRefreshInterval = setInterval(loadJobs, 10000);
    
    console.log('üîÑ Real-time updates started - Countdowns refresh every second, data refreshes every 10 seconds');
}

// ENHANCED: Stop real-time updates (useful for debugging)
function stopRealTimeUpdates() {
    if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
    }
    if (dataRefreshInterval) {
        clearInterval(dataRefreshInterval);
        dataRefreshInterval = null;
    }
    document.getElementById('refreshStatus').textContent = '‚è∏Ô∏è Auto-refresh: OFF';
    console.log('‚è∏Ô∏è Real-time updates stopped');
}

// ENHANCED: Load jobs and store data
async function loadJobs() {
    try {
        const response = await fetch('/admin/scheduler/jobs');
        const jobs = await response.json();
        
        // Store jobs data globally for real-time updates
        jobsData = jobs;
        
        // Update last updated timestamp
        const now = new Date();
        document.getElementById('lastUpdated').textContent = `Last updated: ${now.toLocaleTimeString()}`;
        document.getElementById('refreshStatus').textContent = 'üîÑ Auto-refresh: ON';
        
        renderJobs(jobs);
        
    } catch (error) {
        console.error('Error loading jobs:', error);
        document.getElementById('jobs-container').innerHTML = '<div class="text-red-500">Error loading jobs</div>';
        document.getElementById('refreshStatus').textContent = '‚ùå Auto-refresh: ERROR';
    }
}

// ENHANCED: Update countdowns in real-time without full reload
function updateCountdowns() {
    if (!jobsData || jobsData.length === 0) return;
    
    // Update each countdown element
    jobsData.forEach((job, index) => {
        const countdownElement = document.getElementById(`countdown-${job.id}`);
        if (countdownElement) {
            const countdown = getCountdown(job.next_run);
            countdownElement.innerHTML = `<div class="text-sm font-mono ${countdown.includes('Running') ? 'text-orange-600 font-bold animate-pulse' : 'text-blue-600'}">${countdown}</div>`;
        }
    });
}

// ENHANCED: Render jobs table
function renderJobs(jobs) {
    const container = document.getElementById('jobs-container');
    
    if (jobs.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <h3 class="text-lg font-semibold mb-2">No scheduled jobs</h3>
                <p class="mb-4">Add your first job using the buttons above</p>
            </div>
        `;
        return;
    }
    
    let html = `
        <div class="overflow-x-auto">
            <table class="w-full table-auto">
                <thead>
                    <tr class="bg-gray-50">
                        <th class="px-4 py-2 text-left">Job Name</th>
                        <th class="px-4 py-2 text-left">Type</th>
                        <th class="px-4 py-2 text-left">Description</th>
                        <th class="px-4 py-2 text-left">Next Run</th>
                        <th class="px-4 py-2 text-left">‚è∞ Live Countdown</th>
                        <th class="px-4 py-2 text-left">Status</th>
                        <th class="px-4 py-2 text-left">Actions</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    jobs.forEach(job => {
        const countdown = getCountdown(job.next_run);
        const statusColor = job.next_run ? 'text-green-600' : 'text-red-600';
        const statusText = job.next_run ? '‚úÖ Active' : '‚ùå Inactive';
        
        html += `
            <tr class="border-b hover:bg-gray-50">
                <td class="px-4 py-2">
                    <div class="font-medium">${job.id}</div>
                </td>
                <td class="px-4 py-2">
                    <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-sm">${job.type}</span>
                </td>
                <td class="px-4 py-2">
                    <div class="text-sm">${job.description || 'No description'}</div>
                </td>
                <td class="px-4 py-2">
                    <div class="text-sm">${job.next_run_formatted || 'Not scheduled'}</div>
                </td>
                <td class="px-4 py-2" id="countdown-${job.id}">
                    <div class="text-sm font-mono ${countdown.includes('Running') ? 'text-orange-600 font-bold animate-pulse' : 'text-blue-600'}">${countdown}</div>
                </td>
                <td class="px-4 py-2">
                    <span class="${statusColor}">${statusText}</span>
                </td>
                <td class="px-4 py-2">
                    <div class="flex space-x-2">
                        <form method="POST" action="/admin/scheduler/remove-job" style="display: inline;">
                            <input type="hidden" name="job_id" value="${job.id}">
                            <button type="submit" class="text-red-600 hover:underline text-sm" onclick="return confirm('Remove job ${job.id}?')">
                                ‚ùå Stop
                            </button>
                        </form>
                    </div>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

// ENHANCED: Get countdown with better formatting
function getCountdown(nextRunISO) {
    if (!nextRunISO) return 'Not scheduled';
    
    const now = new Date();
    const nextRun = new Date(nextRunISO);
    const diff = nextRun - now;
    
    if (diff <= 0) return 'üöÄ Running Now!';
    
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
    
    if (days > 0) {
        return `‚è∞ ${days}d ${hours}h ${minutes}m ${seconds}s`;
    } else if (hours > 0) {
        return `‚è∞ ${hours}h ${minutes}m ${seconds}s`;
    } else if (minutes > 0) {
        return `‚è∞ ${minutes}m ${seconds}s`;
    } else {
        return `‚è∞ ${seconds}s`;
    }
}

// Modal functions
function openQuickScheduleModal() {
    document.getElementById('quickScheduleModal').classList.remove('hidden');
}

function closeQuickScheduleModal() {
    document.getElementById('quickScheduleModal').classList.add('hidden');
}

function openAddJobModal() {
    document.getElementById('addJobModal').classList.remove('hidden');
}

function closeAddJobModal() {
    document.getElementById('addJobModal').classList.add('hidden');
}

function updateScheduleOptions(scheduleType) {
    const timeSelection = document.getElementById('timeSelection');
    const dayOfWeekSelection = document.getElementById('dayOfWeekSelection');
    const dayOfMonthSelection = document.getElementById('dayOfMonthSelection');
    const customCronSelection = document.getElementById('customCronSelection');
    const customMinutesInput = document.getElementById('customMinutesInput');
    
    // Hide all additional options first
    timeSelection.classList.add('hidden');
    dayOfWeekSelection.classList.add('hidden');
    dayOfMonthSelection.classList.add('hidden');
    customCronSelection.classList.add('hidden');
    customMinutesInput.classList.add('hidden');
    
    // Show relevant options based on selection
    if (scheduleType === 'custom_minutes') {
        customMinutesInput.classList.remove('hidden');
    } else if (scheduleType === 'daily') {
        timeSelection.classList.remove('hidden');
    } else if (scheduleType === 'weekly') {
        timeSelection.classList.remove('hidden');
        dayOfWeekSelection.classList.remove('hidden');
    } else if (scheduleType === 'monthly') {
        timeSelection.classList.remove('hidden');
        dayOfMonthSelection.classList.remove('hidden');
    } else if (scheduleType === 'custom_cron') {
        customCronSelection.classList.remove('hidden');
    }
}

function toggleMinutesInput(scheduleType) {
    const minutesSection = document.getElementById('minutesInputSection');
    if (scheduleType === 'interval') {
        minutesSection.style.display = 'block';
    } else {
        minutesSection.style.display = 'none';
    }
}

async function addPredefinedJob(jobType) {
    const schedules = {
        'trending_topics': {
            job_type: 'trending_topics',
            schedule_type: 'every_2_hours',
            description: 'üî• Update trending topics with AI every 2 hours'
        },
        'blog_generation': {
            job_type: 'blog_generation', 
            schedule_type: 'every_4_hours',
            description: 'üìù Generate blog posts every 4 hours'
        },
        'cleanup': {
            job_type: 'cleanup',
            schedule_type: 'daily',
            hour: '2',
            minute: '0',
            description: 'üßπ Daily database cleanup at 2 AM'
        }
    };
    
    const jobData = schedules[jobType];
    if (!jobData) return;
    
    try {
        const formData = new FormData();
        Object.keys(jobData).forEach(key => {
            formData.append(key, jobData[key]);
        });
        
        const response = await fetch('/admin/scheduler/quick-schedule', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            window.location.reload();
        } else {
            alert('Failed to add job');
        }
    } catch (error) {
        console.error('Error adding predefined job:', error);
        alert('Error adding job');
    }
}

// ENHANCED: Add page visibility API to pause updates when tab is hidden
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        console.log('üîï Tab hidden - pausing real-time updates');
        if (countdownInterval) {
            clearInterval(countdownInterval);
            countdownInterval = null;
        }
    } else {
        console.log('üëÅÔ∏è Tab visible - resuming real-time updates');
        if (!countdownInterval) {
            countdownInterval = setInterval(updateCountdowns, 1000);
        }
        // Immediately refresh data when tab becomes visible
        loadJobs();
    }
});

// Close modals when clicking outside
document.addEventListener('click', function(event) {
    const quickModal = document.getElementById('quickScheduleModal');
    const addModal = document.getElementById('addJobModal');
    
    if (event.target === quickModal) {
        closeQuickScheduleModal();
    }
    if (event.target === addModal) {
        closeAddJobModal();
    }
});

// ENHANCED: Add keyboard shortcuts for debugging
document.addEventListener('keydown', function(event) {
    // Ctrl+Shift+R: Force refresh jobs
    if (event.ctrlKey && event.shiftKey && event.code === 'KeyR') {
        event.preventDefault();
        console.log('üîÑ Force refreshing jobs...');
        loadJobs();
    }
    
    // Ctrl+Shift+P: Toggle auto-refresh
    if (event.ctrlKey && event.shiftKey && event.code === 'KeyP') {
        event.preventDefault();
        if (countdownInterval) {
            stopRealTimeUpdates();
        } else {
            startRealTimeUpdates();
        }
    }
});

console.log('‚è∞ Enhanced Scheduler UI with LIVE COUNTDOWN loaded successfully!');
console.log('üí° Keyboard shortcuts: Ctrl+Shift+R = Force refresh, Ctrl+Shift+P = Toggle auto-refresh');
</script>
{% endblock %}
